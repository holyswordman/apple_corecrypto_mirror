/*
 * Copyright (c) 2017,2018 Apple Inc. All rights reserved.
 *
 * corecrypto Internal Use License Agreement
 *
 * IMPORTANT:  This Apple corecrypto software is supplied to you by Apple Inc. ("Apple")
 * in consideration of your agreement to the following terms, and your download or use
 * of this Apple software constitutes acceptance of these terms.  If you do not agree
 * with these terms, please do not download or use this Apple software.
 *
 * 1.    As used in this Agreement, the term "Apple Software" collectively means and
 * includes all of the Apple corecrypto materials provided by Apple here, including
 * but not limited to the Apple corecrypto software, frameworks, libraries, documentation
 * and other Apple-created materials. In consideration of your agreement to abide by the
 * following terms, conditioned upon your compliance with these terms and subject to
 * these terms, Apple grants you, for a period of ninety (90) days from the date you
 * download the Apple Software, a limited, non-exclusive, non-sublicensable license
 * under Apple’s copyrights in the Apple Software to make a reasonable number of copies
 * of, compile, and run the Apple Software internally within your organization only on
 * devices and computers you own or control, for the sole purpose of verifying the
 * security characteristics and correct functioning of the Apple Software; provided
 * that you must retain this notice and the following text and disclaimers in all
 * copies of the Apple Software that you make. You may not, directly or indirectly,
 * redistribute the Apple Software or any portions thereof. The Apple Software is only
 * licensed and intended for use as expressly stated above and may not be used for other
 * purposes or in other contexts without Apple's prior written permission.  Except as
 * expressly stated in this notice, no other rights or licenses, express or implied, are
 * granted by Apple herein.
 *
 * 2.    The Apple Software is provided by Apple on an "AS IS" basis.  APPLE MAKES NO
 * WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION THE IMPLIED WARRANTIES
 * OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE, REGARDING
 * THE APPLE SOFTWARE OR ITS USE AND OPERATION ALONE OR IN COMBINATION WITH YOUR PRODUCTS,
 * SYSTEMS, OR SERVICES. APPLE DOES NOT WARRANT THAT THE APPLE SOFTWARE WILL MEET YOUR
 * REQUIREMENTS, THAT THE OPERATION OF THE APPLE SOFTWARE WILL BE UNINTERRUPTED OR
 * ERROR-FREE, THAT DEFECTS IN THE APPLE SOFTWARE WILL BE CORRECTED, OR THAT THE APPLE
 * SOFTWARE WILL BE COMPATIBLE WITH FUTURE APPLE PRODUCTS, SOFTWARE OR SERVICES. NO ORAL
 * OR WRITTEN INFORMATION OR ADVICE GIVEN BY APPLE OR AN APPLE AUTHORIZED REPRESENTATIVE
 * WILL CREATE A WARRANTY.
 *
 * 3.    IN NO EVENT SHALL APPLE BE LIABLE FOR ANY DIRECT, SPECIAL, INDIRECT, INCIDENTAL
 * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
 * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) ARISING
 * IN ANY WAY OUT OF THE USE, REPRODUCTION, COMPILATION OR OPERATION OF THE APPLE
 * SOFTWARE, HOWEVER CAUSED AND WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING
 * NEGLIGENCE), STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 *
 * 4.    This Agreement is effective until terminated. Your rights under this Agreement will
 * terminate automatically without notice from Apple if you fail to comply with any term(s)
 * of this Agreement.  Upon termination, you agree to cease all use of the Apple Software
 * and destroy all copies, full or partial, of the Apple Software. This Agreement will be
 * governed and construed in accordance with the laws of the State of California, without
 * regard to its choice of law rules.
 *
 * You may report security issues about Apple products to product-security@apple.com,
 * as described here:  https://www.apple.com/support/security/.  Non-security bugs and
 * enhancement requests can be made via https://bugreport.apple.com as described
 * here: https://developer.apple.com/bug-reporting/
 *
 * EA1350
 * 10/5/15
 */

#include "testmore.h"
#include "testbyteBuffer.h"
#include <corecrypto/cc_runtime_config.h>
#include <corecrypto/ccdh.h>
#include <corecrypto/ccdh_priv.h>
#include <corecrypto/ccdh_gp.h>
#include <corecrypto/ccsha2.h>

#include "cavs_common.h"
#include "cavs_dispatch.h"
#include "cavs_op_dh_secret.h"

#include "crypto_test_dh_secret.h"

void fipscavs_tests_dh_secret(void)
{
    cc_size n = ccn_nof(2048);
    size_t s = ccn_sizeof_n(n);
    ccdh_gp_decl(s, gp);

    { /* Function - Initiator */
        struct cavs_op_dh_secret vector = {
            .vector = CAVS_VECTOR_DH_SECRET,
            .p_len = 256,
            .p = (uint8_t *)"\xab\xca\xc1\x79\x9a\xbd\x45\x37\xca\x2d\x70\xdb\x05\x7c\x78\xa0\x44\x3e\x7a\xd4\x44\x5b\x4b\x47\x0e\x4a\x0c\x12\xe7\x6f\x2d\xe3\xb3\x3c\x1b\x4c\x0e\xb7\x40\x28\x41\x59\x75\x16\xbf\xff\xb5\x74\xee\x94\x05\xee\x71\x41\xcd\x7f\x00\xa3\x26\x22\x0f\xfc\xce\x10\x86\x8a\x3e\x99\x15\x27\x25\x16\x7e\x64\x3d\xb2\x8b\x96\x05\x02\x94\xfc\xeb\xdb\xd8\xbe\x94\xa0\x8e\x59\x46\xad\x12\x88\x04\xfd\xcc\x7b\x1d\xc2\x67\x66\x32\x3a\x9e\xdb\xd0\x54\x6d\x94\xd6\x53\x25\xd1\x9c\xbb\x0c\xb2\x2f\x52\x85\x9f\x39\xfe\x35\xa9\x37\xaa\x6d\xbe\x31\x04\x18\xb4\xfd\xc6\xbf\x5e\x47\xb0\x53\xc6\xb3\x51\x35\x81\xd5\x61\x05\xc7\xf6\xf3\xd3\xe3\xc7\x84\x7d\x3c\xa0\xad\xbc\x52\xf4\x84\xff\xaf\xda\x7a\x1b\x13\x19\xa0\x21\x8c\xa2\x3d\x90\xe9\xb9\x28\x82\xfb\xdc\x11\xeb\xfa\xf1\x36\xa4\x20\x00\x2f\x32\x2d\x08\x7f\x6b\xa4\xa4\x30\x99\x43\x10\xc9\x97\x4c\x6c\x04\x92\xfd\xbd\x0b\x42\x93\x8d\x69\x8d\xdb\x32\x5b\x20\xa9\x1c\x56\x89\x60\xe0\xa9\x02\xe3\x86\xeb\xe6\x3b\xec\x61\x46\x47\xe0\x48\x64\x97\x92\x40\x3c\x52\xcc\x2a\x35\x7a\x7d\x67\x18\x26\x0e\x35",
            .g_len = 256,
            .g = (uint8_t *)"\x3c\x01\xc1\xad\x30\x52\x1d\x2c\x7a\x2a\x85\x65\xd2\x2c\x3e\x82\xa0\xeb\xba\x7e\x41\x57\x9f\x52\xe5\x16\xa7\x75\x71\x46\xb8\xec\xae\x4c\x34\x5b\xb6\x1e\x99\x13\x73\xec\xf5\x7b\x2b\x7b\x20\xab\x9e\xd7\x3a\x27\x8c\x8b\x16\x7e\x04\xcb\x8e\x28\x8e\xac\x92\x40\x51\x0d\x36\x71\x3a\x73\x5b\x6b\x70\x45\x1c\x81\x00\x18\x2b\xd2\x21\xac\x86\x26\x18\x07\x0d\xe8\xc1\x42\xa4\x86\xb1\xa6\xb7\xe2\x8e\x59\x42\x5a\xe5\x30\x1b\x80\x3e\xa8\x0e\x91\xd6\xb0\x38\x99\x4c\x35\x93\x8c\xe9\xd4\xc9\xa7\x3c\x33\x76\x05\x34\xe4\x76\x0c\x45\xb9\xab\xb3\x86\x15\xf2\x69\xe2\xaa\x3a\xd5\xbf\x7e\x65\x32\xa0\xeb\x40\x8c\xc7\x08\xc6\x7f\x06\x4f\xe5\xa2\x4e\x89\xdb\x58\xdb\x5c\x4c\xd5\x60\xdf\x89\x0e\x75\xf7\x31\x64\xae\xc0\xaa\xdb\x38\x51\xe3\xe7\xd2\x9e\x09\x66\x74\x65\x7a\xb9\x3c\x0a\x7a\x17\xf1\xd4\x4c\xad\x8a\xc7\x83\xa2\x85\xff\xd4\x51\x4b\x07\x0f\x59\x90\x95\x8a\xee\xca\x97\xfb\x9a\x76\x54\x6c\xfe\x8a\x9a\x5e\xf3\x54\x2b\xa0\x41\xee\x43\x82\xbd\xd5\x91\x78\xd3\x2b\x88\xb4\xae\x22\xf2\x1f\xa3\x55\xe2\x71\x9f\x9b\x5b\xba\x8d\x89\x43\x33\xac",
            .q_len = 28,
            .q = (uint8_t *)"\xa4\xb7\xfc\xfc\xe5\x70\x2b\xe8\xed\xe3\x95\xb8\x76\x58\xb9\xed\xd7\xfc\x16\xea\xfd\x55\x2d\x28\xf0\x64\x44\xeb",
            .y_len = 256,
            .y = (uint8_t *)"\x4b\xfc\xad\x37\xb9\xa1\x4d\xbf\xa4\xb8\x18\xcc\xca\x33\x35\x85\xa7\xee\x3a\xe9\x08\x8a\xf4\x6b\x36\x8c\x57\xc3\xfe\x3f\x29\x1f\x22\xa5\x00\x06\x5b\x33\x0e\x4a\x01\x99\x06\x7e\xa9\x92\x43\x47\x73\x1b\xd1\xf5\x26\x84\x32\x70\xa8\xe5\xd4\x74\x53\x44\x64\x73\xf4\x57\xa8\x29\xce\xd8\xf2\x07\x11\xa7\x5b\xde\x45\x25\x8d\x05\x08\x1d\x56\x4e\xb6\xfa\xa9\xea\xb9\xb7\xbb\xad\x60\x3c\x23\xf8\xd1\x4c\x26\x1f\xca\xcf\x07\x1f\x9e\xc4\x67\x27\xa6\x2e\x09\x7a\x0f\x88\xc7\xc2\xc5\x6c\x7e\x43\xca\xc6\x65\xbf\x11\x06\x75\x67\x22\x38\x4c\x57\xd5\xd9\x8c\xf9\x9d\x3f\x48\x9b\x89\xa0\x15\x93\x4c\xe7\xff\x9e\x75\xe3\x54\xfc\xf2\x05\x78\x4a\x2b\x8c\xbe\x40\x03\x5a\xec\x73\x3e\x50\xb2\x6e\xb8\xf1\x1e\xcf\x29\x7d\xec\x16\xbf\x6e\x1b\x89\xa2\x3c\x3c\x68\x64\xfa\xde\xfb\xc7\x83\xbc\xa7\x47\x1c\xb1\x94\x64\x87\x07\xbd\xda\xd7\x12\x73\x35\x39\x7d\x5f\x9d\x19\x4d\x36\xcc\x97\x1e\x13\xce\x96\xbd\xf9\x6c\xe8\xf7\xa3\xa7\x42\xbc\x3f\xa9\xf9\xd6\x3f\xad\x2e\x0c\xf5\x33\x23\x4b\x10\x3f\x04\x7a\x4a\x8f\x15\x0b\x47\xfa\x3f\x6c\x71\x41\xfc\x03\x83",
            .xiut_len = 0,
            .xiut = NULL,
            .yiut_len = 0,
            .yiut = NULL,
        };

        is(ccdh_init_gp_from_bytes(gp, n, vector.p_len, vector.p, vector.g_len,
                    vector.g, vector.q_len, vector.q, 0), 0, "gp init");

        uint8_t *wksp = NULL;
        size_t len = sizeof(uint32_t) + ccdh_ccn_size(gp) + CCSHA256_OUTPUT_SIZE;

        is(CAVS_STATUS_OK, cavs_dispatch(CAVS_TARGET_USER, vector.vector, &vector, &wksp, &len), "dispatch");

        len = *(uint32_t *)wksp;
        is(len, ccdh_ccn_size(gp), "returned components match size of group");
        // TBD - determine some way of qualifying the return values as 'correct'.
        //uint8_t *y = wksp + sizeof(uint32_t);
        //uint8_t *hash = y + len;

        //const uint8_t *exp_y = (const uint8_t *) "\x00\x83\x48\xf1\x86\xa3\x4e\x11\xcc\x0b\x25\xdb\x48\xc2\x10\xeb\x20\x0e\x12\x67\xb6\x73\x30\x25\xd3\x38\xba\xc8\xb2\x72\x17\xf9\x91\xe7\xe5\x4b\xc2\x3c\xe5\x54\xed\x33\x79\x58\x3a\x26\xea\x7a\x5b\x85\x74\x7c\xfb\x10\xbe\x86\xad\x61\x3f\x8b\xf4\x6e\xbe\x23\xb3\x41\x9c\xf7\xce\xe9\x26\xf2\x8e\x74\xdb\x40\xa5\x27\xa2\xf1\x3e\x65\xec\x30\x4f\x48\xe9\xad\x95\xae\x63\x36\x54\x1f\xcd\x61\x42\x50\x06\xfe\xa4\xe0\x61\xe8\xa2\x30\xc7\xc6\xdf\x6c\x6b\xe5\x41\x6a\xda\x05\xf2\xec\xa0\x06\xbd\x30\xb8\xac\x7c\xf5\x31\x4f\x1a\x5a\x75\xe4\x9d\xdd\x90\x1e\x9b\xac\xac\xa6\x04\x01\x82\xb9\x7f\xc6\x03\x67\x05\xbc\x02\x59\x90\xe8\xbc\x1b\x0d\xdc\x43\x00\x2c\xeb\x35\x30\xcf\x22\x46\xbb\xaa\x77\xc3\x72\x97\x9c\xc1\x91\x23\x96\x1b\xfc\xa1\xf4\xa2\xa3\xbb\xa2\x89\x45\xea\xb0\xfc\xad\x24\x7f\x53\x34\xb7\x1b\x2d\x1c\x2c\x4f\xc5\x9d\xa8\x35\xac\x84\x3b\x05\x3a\xec\x1c\x2f\x68\x8b\x56\xb1\xcd\xcb\x92\x9d\x4c\xab\xe7\x05\x2f\x2f\x8f\x0c\x9b\xa1\x01\xc6\x39\xc1\xae\x74\x3d\xdf\x84\xfd\xeb\x64\x61\xfd\xdd\xf3\x35\x14\x45\x78\x46\x7d\xa1\x84\x4e";
        //const uint8_t *exp_hash = (const uint8_t *) "\x4d\x02\xfa\x42\xeb\xa6\xbd\x1f\x53\xcd\x2f\xa6\x1f\x18\xb9\x9c\x47\x23\x8b\xc9\xf0\xcb\x70\xe5\xc0\xb8\xb2\x37\x39\x77\x18\xac";
        //ok_memcmp(y, exp_y, len, "y");
        //ok_memcmp(hash, exp_hash, CCSHA256_OUTPUT_SIZE, "hash");
    }
    { /* Validity - Initiator - Pass */
        struct cavs_op_dh_secret vector = {
            .vector = CAVS_VECTOR_DH_SECRET,
            .p_len = 256,
            .p = (uint8_t *)"\xa8\x48\x1e\x13\x14\xe8\x1c\x32\xdd\x6f\xfe\x2f\x76\x57\xdd\xa4\xca\xdc\xae\x29\x3c\x2c\xe8\xd4\x30\xf1\x93\x2d\xde\xce\xa9\x39\xd8\x3f\xa9\xd5\x60\x3c\x41\xad\x18\xef\x5d\xbe\x2f\x07\xab\x68\x9c\x44\xf7\xc0\x0b\x3f\x75\x1b\x34\xb1\xfe\x3e\x29\x5d\x3f\x7f\x0c\xcb\x08\x65\x44\x46\x3e\xf3\xb3\x70\xb6\x50\x00\x4c\x0b\xd0\x0b\x5d\xcb\x8f\x3d\xdd\x11\xe0\x95\x83\x59\x2c\x96\x67\xe1\x14\x93\xaf\xd8\x04\xaf\x63\x09\xc4\x90\x5b\x2f\x3b\x7a\x82\xb9\x10\x9a\xd1\xee\x33\x32\x80\x51\x92\xc5\x90\x27\x09\x8b\x9a\xea\xef\x6d\x0c\x88\x3c\x29\x34\xb6\xa7\x85\x44\x8f\x1d\xca\xf1\x23\x4c\xf6\x62\xc8\x8a\x4b\xb6\x44\x89\x16\xc5\x14\xa6\x7f\x47\x09\xbc\xd0\xc3\x67\xc8\xad\xc1\x18\x1f\x67\x6c\x9a\x99\xac\x24\xdc\x93\x6f\x41\x1a\xb1\x74\x61\x3c\x55\x87\x5c\x36\xdc\x65\x46\xcc\x64\x7c\x3b\xba\x40\xe9\x9e\x65\x44\x07\x40\xc7\x90\xb1\x09\x7c\x08\xdb\xbb\x3f\x4f\x06\xe1\x67\x84\x61\xae\x67\x7b\xe8\x0a\x2e\x8c\x8a\x26\x2e\x11\xe7\x4c\xb8\x44\x14\x9a\xa1\x67\x1f\x60\xce\x10\xc4\xcb\xa3\xc7\x45\xc9\xab\xb2\xab\x4a\x53\x45\x78\xc8\xe8\x7b",
            .g_len = 256,
            .g = (uint8_t *)"\x5d\x16\x19\x27\xba\xbc\x5c\xb5\xb1\xb5\xb4\x1b\x74\x7b\x3c\x73\xe7\x93\x3c\x3e\xff\x48\x8b\x25\xa1\x9c\x65\xb5\xf1\x46\x86\xdd\x85\x9b\x5d\xe2\x7a\xe5\x9d\xdc\xc2\x28\x18\x18\x59\x6f\xea\xc7\x19\xa3\x61\xd5\x88\xba\x16\xf2\x40\xe0\x83\x42\xc9\xc3\xbd\xea\xbc\xe4\xdc\x70\xa0\x34\x35\x4d\x22\x09\xc2\x49\xc3\x8e\xcc\x9a\x8b\x83\x28\xcb\x91\x8e\x98\xc4\x08\xa8\x2b\x8e\x46\xfd\x1d\xbf\x19\xbd\x8b\x92\xae\xfb\x3d\x2e\xf3\xfa\xf9\x57\x48\x67\x30\xf3\xd3\xde\x4a\xd1\xf5\x00\xd1\x23\x3a\x94\x0a\xc2\xf8\x5a\x54\x3d\x9f\x09\xf9\x07\x8d\xae\xcd\x19\x3e\x49\xf4\x93\xc4\x86\x56\x92\xd9\x1f\x20\x08\x43\x71\x74\xb0\x55\x6d\x65\x4a\x26\xed\x5d\x1d\xef\x5b\x8d\x64\x3c\x47\x0e\x21\x22\x6b\x1f\xe6\x6d\x88\x74\xe0\x09\x7e\x1f\x11\x8b\xd4\xea\x06\xb9\x33\xb5\x33\xb8\xf2\x54\x9e\xdc\xb0\xe0\xcd\xa5\xae\x13\xd0\xa0\x12\x5d\xff\x42\xe1\x8a\xd0\xb2\xa4\xf8\x55\x3c\x9c\x79\xd0\xa0\x7b\x62\x17\xca\x66\xa5\xa7\xad\x8e\xf7\x8e\xff\x8c\xae\xf7\xcf\x21\x5f\x47\xaf\xb6\x12\x9d\xca\xb8\x86\x74\xea\xfb\xa2\x5b\x77\x49\x65\x14\x3f\x42\x67\x18",
            .q_len = 28,
            .q = (uint8_t *)"\xe9\xea\x08\xae\x7c\xa3\x27\x81\x0a\x37\xc8\x97\x6e\xe4\xcc\x21\xa9\xd2\xbe\x4a\x0d\xbd\x8d\xf0\x1e\xf3\x6e\x2f",
            .y_len = 256,
            .y = (uint8_t *)"\x49\x50\x7f\x50\xf8\xe3\x57\xb5\x0d\x3e\x4c\x55\x89\xb8\x21\x85\x94\x3e\x95\x09\xb0\x33\x63\xf1\x88\x34\x06\xc1\xdc\x8e\xbe\x22\xf2\x9e\xab\xec\xd8\x3f\xb4\x2e\x3d\x83\x7a\x56\xb3\x5a\x78\xa6\x7d\x59\xb3\x2b\x74\x8f\xa5\x0c\x78\xf6\x5b\x2a\x8e\x86\xe2\x94\x95\x92\x2c\x6f\x43\xa8\xb5\xe6\x16\xc7\x4e\xc7\x08\xae\x33\x0a\x58\x6d\xa0\xc5\x0b\x4b\x49\x57\xe0\xff\xfb\x9d\x70\xc5\x9d\x17\x80\xf8\xc1\x7e\xe2\x40\x7c\xc3\x5b\x9e\xbb\x3e\xa9\x7d\x35\x19\xe0\x44\x99\xc0\xfe\x61\xbd\xb6\x63\x0a\xe5\x9c\x38\xa4\x62\x47\xce\x46\xaf\xde\xfe\xea\x0a\x0b\xbc\x1b\x24\x95\x83\xc6\x42\xb4\x52\xdc\xfc\x70\x91\xcd\xc6\xf7\x2f\xeb\x73\x6e\xbb\xf5\x52\x67\x0a\x59\x9c\x11\x7d\xcd\x0c\xd2\xa5\xf1\xda\xbf\x0a\x8f\x27\x13\xb5\xcd\x5f\x8b\x30\x6e\x93\xc7\xb9\xf2\xe8\xad\xe4\x67\x06\x07\x6e\x7d\x9c\x09\x10\xa9\x92\xf4\x62\x4b\x00\xfc\xeb\xf0\xf9\xab\x2e\x5f\xb5\xbc\x19\x0e\xeb\xeb\xd1\xd9\xbf\x56\x67\x4c\x4a\xaf\x13\xa8\x6e\xfa\x35\x66\x33\x24\xea\x71\x5b\x92\x97\x3e\xb3\xb9\x61\x38\x0f\x44\xa8\xdb\xdd\x82\xd7\x3f\x3a\x9a\xf1\x16\x9a\xcb",
            .xiut_len = 28,
            .xiut = (uint8_t *)"\x3b\x6a\xf9\x70\x9a\xae\x65\x03\x8e\x54\xad\x85\x1f\x94\xa1\x09\xa6\x90\x06\x89\x4f\x80\xe9\x65\xf5\x78\x6f\x34",
            .yiut_len = 256,
            .yiut = (uint8_t *)"\x4a\xcc\x2b\xc7\x58\xfd\x72\x5f\xa9\x96\xb0\x80\x0e\x05\x6c\xb3\xbb\x20\x54\xae\x3f\x8a\xc6\x35\xcd\x06\xcf\xf1\x63\x26\x29\x85\xab\xb2\x47\xa9\x28\x04\xcd\xe5\x98\x55\x2d\x54\x10\x19\xd3\x7e\x76\x1c\x12\x22\x33\x38\xd2\xe0\x9b\x5f\x11\x9d\xa2\x7c\x30\x9f\x81\xd9\x2b\xfb\xa4\xf7\x66\x38\x6a\x7d\x9d\x74\x40\x9f\x41\xf6\xe9\xbf\xeb\x8d\xab\xfe\xa4\xb8\xff\x00\xeb\x3f\x01\xfc\x4f\x58\x99\x7f\x89\x90\x75\x98\x8c\xab\xc8\x6c\xc7\x73\x9b\x56\xa5\xb6\x0d\x32\x34\xdc\xe4\x3f\xf7\xa5\x6b\xe7\xc1\xfb\xf5\x37\xda\xff\x59\x8e\xf4\xd4\xd7\xab\xac\xc4\xe5\x33\xf0\x8d\x8d\x2d\x44\xba\x54\x35\xb7\x28\x30\x83\x7f\xa9\x0f\x60\x1b\xff\xb9\x85\xea\xc7\xa9\x42\xaa\x93\x00\xe9\xaf\xe6\x96\x91\x96\xcb\x22\x5c\x50\xfc\xea\x04\x27\x21\xf9\xab\xa3\x3a\xc3\x1d\x94\x6b\xeb\x77\xb3\x7a\x6b\x35\x09\x89\x68\x10\xcf\x08\xb9\xf6\x5c\x93\xc0\x8d\x8d\x0d\x99\x71\x5f\xe3\xb7\x63\xe5\x7a\x17\x42\xed\xa4\x31\x56\x87\x66\x94\x2c\x84\xf0\x6d\xb8\xf1\x45\x17\xba\x84\x98\x99\x57\x55\x7c\x66\x45\x26\x1a\xf1\xd5\xb5\x43\x6a\x6c\xbe\x1b\x94\xf4\x70\x94",
        };

        is(ccdh_init_gp_from_bytes(gp, n, vector.p_len, vector.p, vector.g_len,
                    vector.g, vector.q_len, vector.q, 0), 0, "gp init");

        uint8_t *wksp = NULL;
        size_t len = sizeof(uint32_t) + ccdh_ccn_size(gp) + CCSHA256_OUTPUT_SIZE;

        is(CAVS_STATUS_OK, cavs_dispatch(CAVS_TARGET_USER, vector.vector, &vector, &wksp, &len), "dispatch");

        len = *(uint32_t *)wksp;
        is(len, ccdh_ccn_size(gp), "returned components match size of group");
        uint8_t *y = wksp + sizeof(uint32_t);
        uint8_t *hash = y + len;

        const uint8_t *exp_hash = (const uint8_t *)"\x05\x17\xa0\xdb\x48\x86\x59\x77\x8b\x36\x84\xe9\x20\x4b\xd2\x42\x1a\x35\x69\x77\xc4\x83\x2f\xe4\x9d\xb3\x2e\x8f\x12\x23\x45\x39";
        ok_memcmp(hash, exp_hash, CCSHA256_OUTPUT_SIZE, "hash");
    }
    { /* Validity - Initiator - Fail */
        struct cavs_op_dh_secret vector = {
            .vector = CAVS_VECTOR_DH_SECRET,
            .p_len = 256,
            .p = (uint8_t *)"\xa8\x48\x1e\x13\x14\xe8\x1c\x32\xdd\x6f\xfe\x2f\x76\x57\xdd\xa4\xca\xdc\xae\x29\x3c\x2c\xe8\xd4\x30\xf1\x93\x2d\xde\xce\xa9\x39\xd8\x3f\xa9\xd5\x60\x3c\x41\xad\x18\xef\x5d\xbe\x2f\x07\xab\x68\x9c\x44\xf7\xc0\x0b\x3f\x75\x1b\x34\xb1\xfe\x3e\x29\x5d\x3f\x7f\x0c\xcb\x08\x65\x44\x46\x3e\xf3\xb3\x70\xb6\x50\x00\x4c\x0b\xd0\x0b\x5d\xcb\x8f\x3d\xdd\x11\xe0\x95\x83\x59\x2c\x96\x67\xe1\x14\x93\xaf\xd8\x04\xaf\x63\x09\xc4\x90\x5b\x2f\x3b\x7a\x82\xb9\x10\x9a\xd1\xee\x33\x32\x80\x51\x92\xc5\x90\x27\x09\x8b\x9a\xea\xef\x6d\x0c\x88\x3c\x29\x34\xb6\xa7\x85\x44\x8f\x1d\xca\xf1\x23\x4c\xf6\x62\xc8\x8a\x4b\xb6\x44\x89\x16\xc5\x14\xa6\x7f\x47\x09\xbc\xd0\xc3\x67\xc8\xad\xc1\x18\x1f\x67\x6c\x9a\x99\xac\x24\xdc\x93\x6f\x41\x1a\xb1\x74\x61\x3c\x55\x87\x5c\x36\xdc\x65\x46\xcc\x64\x7c\x3b\xba\x40\xe9\x9e\x65\x44\x07\x40\xc7\x90\xb1\x09\x7c\x08\xdb\xbb\x3f\x4f\x06\xe1\x67\x84\x61\xae\x67\x7b\xe8\x0a\x2e\x8c\x8a\x26\x2e\x11\xe7\x4c\xb8\x44\x14\x9a\xa1\x67\x1f\x60\xce\x10\xc4\xcb\xa3\xc7\x45\xc9\xab\xb2\xab\x4a\x53\x45\x78\xc8\xe8\x7b",
            .g_len = 256,
            .g = (uint8_t *)"\x5d\x16\x19\x27\xba\xbc\x5c\xb5\xb1\xb5\xb4\x1b\x74\x7b\x3c\x73\xe7\x93\x3c\x3e\xff\x48\x8b\x25\xa1\x9c\x65\xb5\xf1\x46\x86\xdd\x85\x9b\x5d\xe2\x7a\xe5\x9d\xdc\xc2\x28\x18\x18\x59\x6f\xea\xc7\x19\xa3\x61\xd5\x88\xba\x16\xf2\x40\xe0\x83\x42\xc9\xc3\xbd\xea\xbc\xe4\xdc\x70\xa0\x34\x35\x4d\x22\x09\xc2\x49\xc3\x8e\xcc\x9a\x8b\x83\x28\xcb\x91\x8e\x98\xc4\x08\xa8\x2b\x8e\x46\xfd\x1d\xbf\x19\xbd\x8b\x92\xae\xfb\x3d\x2e\xf3\xfa\xf9\x57\x48\x67\x30\xf3\xd3\xde\x4a\xd1\xf5\x00\xd1\x23\x3a\x94\x0a\xc2\xf8\x5a\x54\x3d\x9f\x09\xf9\x07\x8d\xae\xcd\x19\x3e\x49\xf4\x93\xc4\x86\x56\x92\xd9\x1f\x20\x08\x43\x71\x74\xb0\x55\x6d\x65\x4a\x26\xed\x5d\x1d\xef\x5b\x8d\x64\x3c\x47\x0e\x21\x22\x6b\x1f\xe6\x6d\x88\x74\xe0\x09\x7e\x1f\x11\x8b\xd4\xea\x06\xb9\x33\xb5\x33\xb8\xf2\x54\x9e\xdc\xb0\xe0\xcd\xa5\xae\x13\xd0\xa0\x12\x5d\xff\x42\xe1\x8a\xd0\xb2\xa4\xf8\x55\x3c\x9c\x79\xd0\xa0\x7b\x62\x17\xca\x66\xa5\xa7\xad\x8e\xf7\x8e\xff\x8c\xae\xf7\xcf\x21\x5f\x47\xaf\xb6\x12\x9d\xca\xb8\x86\x74\xea\xfb\xa2\x5b\x77\x49\x65\x14\x3f\x42\x67\x18",
            .q_len = 28,
            .q = (uint8_t *)"\xe9\xea\x08\xae\x7c\xa3\x27\x81\x0a\x37\xc8\x97\x6e\xe4\xcc\x21\xa9\xd2\xbe\x4a\x0d\xbd\x8d\xf0\x1e\xf3\x6e\x2f",
            .y_len = 256,
            .y = (uint8_t *)"\x26\x35\x20\xde\x53\xe1\x88\x1f\xb8\xd6\x16\x5c\x9a\x98\x96\x53\xd0\xd8\x23\x72\xfc\x76\xca\x8f\x8d\x37\x16\x0d\x02\x9a\x53\x92\x4a\xc0\x4e\x15\x9f\x45\x88\x86\x17\x37\x07\x7f\xcf\x0c\x95\x9a\x96\xe3\x35\x4b\x87\x00\x24\xd6\xe5\x5b\xb6\xc7\xf5\xe3\x68\x41\x03\x5e\x0e\xb7\xd0\x96\x33\x06\x96\x5a\xfe\xfe\xfa\xd0\xd9\x20\x37\xb4\xee\xf1\xb5\xdd\xd5\xae\xab\x5a\x89\xcc\xdf\x52\xce\x47\x5e\x1b\xb4\x40\x99\x63\x54\x4b\x21\xfc\x9a\x8c\x95\xb5\xc0\xb1\x0b\xa5\x17\xb5\x0a\xb6\x8d\xd1\x02\x8d\xb0\x32\x0a\xcc\xca\x54\x7d\x29\x46\x54\xe4\xce\x1e\xb4\x11\x08\xa7\x77\x02\x25\xe9\xf8\x6d\x10\xf3\x2e\x06\x5c\xe7\xe8\x40\x9e\xb9\x4d\x8e\x78\xee\xbc\x33\xc0\x35\x0c\xf3\x22\x0d\x1d\xae\x31\x65\x54\x86\xe1\xbb\x3d\x7a\xed\x44\x6a\x5f\x04\x4a\x27\xf8\xb7\x70\x72\x18\x59\xf9\x24\x6b\x81\xa1\x97\xb5\xb3\x94\x81\xd3\xaf\xe8\x0a\x2a\x19\x27\x82\xd3\x8d\x7d\x18\xe1\x28\xe7\x1b\xec\x71\x39\xc1\xf3\x16\x17\x15\xc6\x9f\x93\x8b\x0e\x1d\x31\x91\xc0\xf7\x4c\x00\xba\x3f\x48\xf9\xf1\xe0\x17\x41\xe2\x7a\xf7\xcd\xdf\xd0\x1c\xe2\xab\xad\xe2\x87",
            .xiut_len = 28,
            .xiut = (uint8_t *)"\x61\x76\x96\x69\xa4\x4d\x07\x3f\x29\x7a\xfd\x15\x92\x3b\x15\x4e\x81\xae\x12\xe4\xba\xee\x51\x9a\x71\x13\x0b\x23",
            .yiut_len = 256,
            .yiut = (uint8_t *)"\xa0\x0b\xe7\xed\x7f\x3d\x3d\x27\xcc\x7b\xc9\x74\x1e\x7b\xfc\x44\x2a\x25\x7a\x1f\x2a\x43\x66\x9a\x98\x3d\x8e\xd3\xd2\x06\xd6\xa8\x6d\x30\x39\x29\x99\x09\x59\x3f\x32\x2c\xfe\x38\xa3\xd0\xa5\xa0\xa6\xa2\xfd\x67\x88\x6e\x7b\x39\xd0\xe0\x24\x5b\x16\x49\x49\xce\x69\x36\xda\x81\x25\x6d\x49\x06\x9b\x89\xbe\x4e\xb4\x20\x17\xfb\x95\x81\x6f\xf9\x64\x7c\xe3\x6e\xed\x0e\x9d\x01\xfa\x4b\x8d\xf1\x87\x70\x86\xe6\xd3\xaa\xc4\x9a\x97\xa8\xab\xe2\x1a\x1f\x7f\xd6\xbb\x4c\xea\x86\xaf\x64\x73\xce\x59\xa6\xe2\x90\xd5\xd0\xa6\x1c\x11\x21\xaa\x0e\xf2\x61\xa6\xb0\x2c\x81\x13\xe1\x74\x46\x06\xf3\x2f\xec\x36\x6f\x7b\xe4\x16\xf3\xe5\x6f\xb1\xd9\xd3\xc4\xf8\x0e\x02\xe7\xc4\x02\x25\x58\x45\x22\xf1\xb9\x62\xac\x4c\x3a\xf1\x17\x0a\x22\x00\x70\xe1\xe6\xc5\xf9\xf5\xae\xfd\x3f\x31\xce\x9e\x88\x86\xdf\x06\xaf\x0e\x95\x28\xf4\x72\x47\x6c\x24\xf6\x71\x2a\x79\x43\xdd\x4b\x26\x32\x92\x9a\x43\x41\x16\x3a\x1c\x27\xea\xbb\x5c\xc4\xa0\xa7\xf1\x90\xdc\x13\xc6\x55\x93\xe6\x8d\x01\xd6\x2e\x56\x22\x20\xb9\x35\xef\x1d\xed\xd0\x3e\xd8\x50\x63\x7e\xaf\x2c\x61",
        };

        is(ccdh_init_gp_from_bytes(gp, n, vector.p_len, vector.p, vector.g_len,
                    vector.g, vector.q_len, vector.q, 0), 0, "gp init");

        uint8_t *wksp = NULL;
        size_t len = sizeof(uint32_t) + ccdh_ccn_size(gp) + CCSHA256_OUTPUT_SIZE;

        is(CAVS_STATUS_OK, cavs_dispatch(CAVS_TARGET_USER, vector.vector, &vector, &wksp, &len), "dispatch");

        len = *(uint32_t *)wksp;
        is(len, ccdh_ccn_size(gp), "returned components match size of group");
        uint8_t *y = wksp + sizeof(uint32_t);
        uint8_t *hash = y + len;

        const uint8_t *exp_hash = (const uint8_t *)"\xf1\x50\x26\x0c\x3d\xe7\xf5\x65\x26\x70\xbc\xea\xdf\x47\x77\x0c\x12\x44\xac\x59\x87\x5b\xe1\x49\x03\x17\xee\x36\xa3\x3a\x1b\x91";
        ok_memcmp(hash, exp_hash, CCSHA256_OUTPUT_SIZE, "hash");
    }
}
