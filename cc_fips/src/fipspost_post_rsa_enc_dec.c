/*
 * Copyright (c) 2017,2018 Apple Inc. All rights reserved.
 *
 * corecrypto Internal Use License Agreement
 *
 * IMPORTANT:  This Apple corecrypto software is supplied to you by Apple Inc. ("Apple")
 * in consideration of your agreement to the following terms, and your download or use
 * of this Apple software constitutes acceptance of these terms.  If you do not agree
 * with these terms, please do not download or use this Apple software.
 *
 * 1.    As used in this Agreement, the term "Apple Software" collectively means and
 * includes all of the Apple corecrypto materials provided by Apple here, including
 * but not limited to the Apple corecrypto software, frameworks, libraries, documentation
 * and other Apple-created materials. In consideration of your agreement to abide by the
 * following terms, conditioned upon your compliance with these terms and subject to
 * these terms, Apple grants you, for a period of ninety (90) days from the date you
 * download the Apple Software, a limited, non-exclusive, non-sublicensable license
 * under Apple’s copyrights in the Apple Software to make a reasonable number of copies
 * of, compile, and run the Apple Software internally within your organization only on
 * devices and computers you own or control, for the sole purpose of verifying the
 * security characteristics and correct functioning of the Apple Software; provided
 * that you must retain this notice and the following text and disclaimers in all
 * copies of the Apple Software that you make. You may not, directly or indirectly,
 * redistribute the Apple Software or any portions thereof. The Apple Software is only
 * licensed and intended for use as expressly stated above and may not be used for other
 * purposes or in other contexts without Apple's prior written permission.  Except as
 * expressly stated in this notice, no other rights or licenses, express or implied, are
 * granted by Apple herein.
 *
 * 2.    The Apple Software is provided by Apple on an "AS IS" basis.  APPLE MAKES NO
 * WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION THE IMPLIED WARRANTIES
 * OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE, REGARDING
 * THE APPLE SOFTWARE OR ITS USE AND OPERATION ALONE OR IN COMBINATION WITH YOUR PRODUCTS,
 * SYSTEMS, OR SERVICES. APPLE DOES NOT WARRANT THAT THE APPLE SOFTWARE WILL MEET YOUR
 * REQUIREMENTS, THAT THE OPERATION OF THE APPLE SOFTWARE WILL BE UNINTERRUPTED OR
 * ERROR-FREE, THAT DEFECTS IN THE APPLE SOFTWARE WILL BE CORRECTED, OR THAT THE APPLE
 * SOFTWARE WILL BE COMPATIBLE WITH FUTURE APPLE PRODUCTS, SOFTWARE OR SERVICES. NO ORAL
 * OR WRITTEN INFORMATION OR ADVICE GIVEN BY APPLE OR AN APPLE AUTHORIZED REPRESENTATIVE
 * WILL CREATE A WARRANTY.
 *
 * 3.    IN NO EVENT SHALL APPLE BE LIABLE FOR ANY DIRECT, SPECIAL, INDIRECT, INCIDENTAL
 * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
 * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) ARISING
 * IN ANY WAY OUT OF THE USE, REPRODUCTION, COMPILATION OR OPERATION OF THE APPLE
 * SOFTWARE, HOWEVER CAUSED AND WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING
 * NEGLIGENCE), STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 *
 * 4.    This Agreement is effective until terminated. Your rights under this Agreement will
 * terminate automatically without notice from Apple if you fail to comply with any term(s)
 * of this Agreement.  Upon termination, you agree to cease all use of the Apple Software
 * and destroy all copies, full or partial, of the Apple Software. This Agreement will be
 * governed and construed in accordance with the laws of the State of California, without
 * regard to its choice of law rules.
 *
 * You may report security issues about Apple products to product-security@apple.com,
 * as described here:  https://www.apple.com/support/security/.  Non-security bugs and
 * enhancement requests can be made via https://bugreport.apple.com as described
 * here: https://developer.apple.com/bug-reporting/
 *
 * EA1350
 * 10/5/15
 */
#include <corecrypto/cc_debug.h>
#include <corecrypto/ccrsa.h>
#include <corecrypto/ccrsa_priv.h>

#include "fipspost.h"
#include "fipspost_priv.h"
#include "fipspost_post_rsa_enc_dec.h"

// DER RSA key used for RSA operation tests pulled from FIPS 186-2 RSA test vectors.
static const unsigned char rsa_test_key[] = "\x30\x82\x04\xa1\x02\x01\x00\x02\x82\x01\x01\x00\x88\xdd\x23\x6b\xe4\x29\x46\xff\xe9\x25\x5e\x07\x9d\x39\xe2\xc9\x00\x50\x93\xeb\x32\x88\x88\xd3\xd8\xba\x3a\x1b\xc8\x6c\x61\x3f\xe2\xe0\x9f\x8c\xbc\x75\x3a\x51\xdf\xec\x6b\xab\xc6\x0b\xca\xe6\x61\x7d\xba\xb5\xc6\x06\x53\x27\x83\xa1\xe1\xf4\x15\x5a\xc0\x4f\x4e\xb2\xee\x03\x0a\x2b\x43\x8a\x1f\xac\x14\x54\xa1\x21\xf1\xfe\x9a\x88\x68\x02\xd7\xb1\xca\xba\xb9\xd4\x24\x11\xc2\x89\x70\x80\xfa\x75\x24\x47\x92\x52\x40\x04\x47\x7d\x9a\x60\xdc\xa9\xd7\x2c\xe6\x8c\x88\x71\xf3\x69\x0e\x59\xa7\xd9\x51\xa7\xa8\x2d\x93\x2f\xe3\x70\xd5\x64\x9e\x69\x06\x94\xb0\x11\xa2\x0d\x64\x41\x9a\x44\x32\xd8\xa8\x72\x35\x52\x7d\xc8\xf9\xa7\x03\x3f\x12\x77\x22\xb2\xe0\xbf\x0a\x07\xb6\x5b\xe9\x13\x24\x60\xf7\xc4\xb1\x4d\x1e\xe1\xa7\x48\xdb\x1d\xcc\xe3\xef\x04\x1c\xac\xb0\x98\xdc\x68\x6a\xb5\x6f\x02\x72\x8e\xec\xe3\x4a\xba\x79\xab\x80\x3b\xb7\x18\xf4\xfc\x9d\x33\xd5\xa1\x38\xd4\x7c\xa7\xfa\x39\x45\xc3\x86\x75\x1f\x0b\x93\x2d\x50\x2b\xc5\x33\x60\xde\x40\xd8\x1f\xa4\x2a\xc8\x32\xb4\x5f\xbb\x1c\xab\x67\xcf\xf7\xe3\xaa\x8d\x54\x85\xea\xc1\x0c\xdd\x02\x01\x03\x02\x82\x01\x00\x16\xcf\x85\xe7\x50\xb1\x8b\xd5\x51\x86\x3a\x56\x9a\x34\x50\x76\xd5\x62\xc3\x51\xdd\xc1\x6c\x23\x4e\xc9\xb4\x59\xf6\xbc\xba\xdf\xfb\x25\x6f\xec\xca\x13\x89\xb8\x4f\xfc\xbc\x9c\xa1\x01\xf7\x26\x65\x94\xf4\x73\xa1\x01\x0d\xdb\xeb\x45\xa5\xa8\xae\x39\xca\xb7\xe2\x73\x27\xab\x2c\x5c\x8b\x41\xaf\xf2\x03\x63\x70\x30\x52\xff\xc4\x6c\x11\x55\xce\x9d\xa1\xc9\xc9\xa3\x5b\x58\x4b\x16\xe8\x15\x7f\x13\x86\x0b\xed\xb8\x60\x00\xb6\x94\xef\x10\x24\xc6\xf9\x32\x26\x6c\xc1\x68\x53\x3c\x2d\x0e\xf1\x4e\xe2\xf1\x46\xb2\x43\x32\x67\x80\xb5\x97\x12\xf7\x44\x58\xea\x78\x45\x89\x51\xb4\xb5\xa5\xc4\x00\xf7\xfa\x77\xbf\x8d\x1f\xa5\xc8\x38\xcf\x03\xeb\x7a\x88\x62\x25\x5d\xf5\x67\xb3\x1e\x5a\x9a\x33\x16\x7c\x8c\x04\xb5\x87\x1f\x39\xbe\x73\x0c\x8b\x14\xf4\x4d\xda\x62\xc8\x31\x66\x57\x10\x20\xaf\xc3\xc5\x73\x86\x7b\xd9\x4d\x93\xe7\x15\x13\x7d\xbd\xa2\xb5\x82\x74\xe5\x05\xb9\x3e\x44\x6c\x93\x43\xc8\xc1\x6d\xc4\xea\x16\x9a\x24\xcd\x14\xcb\xb6\xc0\xb7\xbd\x82\x90\xd7\x86\xb2\x25\x3b\x8a\xe8\x50\xa8\x26\xcd\x55\xd6\xd4\x24\x5e\x56\x2d\xf3\xa5\x02\x81\x81\x00\xbe\x8f\xc2\x63\x3f\x1d\x1e\x7d\xb1\xd0\x2d\x17\xc9\x16\xf6\x33\x54\x16\x4d\x5e\x7b\xe9\x40\x86\x45\x07\xb2\x0c\x5d\xff\x46\x1a\x16\x6c\x7f\x37\xac\x24\x25\x18\xcd\xb2\xea\xb9\x57\x07\x4d\xad\x64\x6c\xbf\xb3\x84\xbb\x04\x89\x49\xcf\xdd\x05\x09\x39\xe4\x61\xdf\x34\xb7\xd7\xf3\xdc\x58\x6d\xfb\x9a\xd4\x13\x02\xe3\x23\xeb\x68\x22\x50\xe8\x2b\xf2\xda\x9a\x64\x91\x59\x48\x15\x91\x64\x40\x21\xd1\xb3\x6b\x9c\xae\x87\x03\x86\x47\xab\xd4\xa1\xae\x05\xbc\x9f\x7f\x2a\xd0\x66\x4a\x3f\x6f\x63\xd2\x93\x18\x96\x14\x4f\xfb\x02\x81\x81\x00\xb7\xdc\xd1\x76\xed\x80\x4e\x01\x7f\x6f\xd3\xbd\xb0\xee\x62\x2e\x46\xbc\x8b\x34\xea\xeb\xee\x84\xd1\xed\xfc\x58\x9c\xf2\xfd\x66\x7d\x72\x57\x0f\x9c\x05\x0d\xda\xb9\x7b\x86\x20\x12\x29\x90\x09\x87\x81\xa4\xb7\xfc\xe6\x6c\xc0\xff\xbe\x82\xe2\xaa\xc8\x7b\xf2\xcb\xaf\x24\x16\x43\xe0\x0b\x34\xac\x99\x41\xaa\x3f\x43\x5f\x40\xf4\x02\xc7\x5a\xea\x8a\x2c\x73\x0a\x34\x55\xc6\xe8\x51\x1d\x4e\xe9\xbe\xbf\xf1\xab\xbe\x91\x56\x6c\x1f\x64\x6a\x7b\xf2\x00\x18\x5a\xfa\x7f\xf7\x10\x9c\xe8\x71\x3d\xc1\xe7\x37\x4f\x99\x07\x07\x02\x81\x80\x7f\x0a\x81\x97\x7f\x68\xbe\xfe\x76\x8a\xc8\xba\x86\x0f\x4e\xcc\xe2\xb9\x88\xe9\xa7\xf0\xd5\xae\xd8\xaf\xcc\x08\x3e\xaa\x2e\xbc\x0e\xf2\xff\x7a\x72\xc2\xc3\x65\xde\x77\x47\x26\x3a\x04\xde\x73\x98\x48\x7f\xcd\x03\x27\x58\x5b\x86\x8a\x93\x58\xb0\xd1\x42\xeb\xea\x23\x25\x3a\xa2\x92\xe5\x9e\xa7\xbc\x8d\x62\x01\xec\xc2\x9c\xf0\x16\xe0\x9a\xc7\xf7\x3c\x66\xed\xb6\x3b\x85\x63\xb6\x42\xd5\x6b\xe1\x22\x47\xbd\xc9\xaf\x57\xae\xda\x72\x8d\xc1\x1e\xae\x7d\xbf\xaa\x1c\x8a\xee\xdc\x2a\x4a\x42\x8c\x62\x10\x64\x0d\x8a\xa7\x02\x81\x80\x7a\x93\x36\x4f\x49\x00\x34\x00\xff\x9f\xe2\x7e\x75\xf4\x41\x74\x2f\x28\x5c\xcd\xf1\xf2\x9f\x03\x36\x9e\xa8\x3b\x13\x4c\xa8\xee\xfe\x4c\x3a\x0a\x68\x03\x5e\x91\xd0\xfd\x04\x15\x61\x71\x0a\xb1\x05\x01\x18\x7a\xa8\x99\x9d\xd5\xff\xd4\x57\x41\xc7\x30\x52\xa1\xdd\x1f\x6d\x64\x2d\x40\x07\x78\x73\x10\xd6\x71\x7f\x82\x3f\x80\xa2\xac\x84\xe7\x47\x06\xc8\x4c\xb1\x78\x39\x2f\x45\x8b\x68\xdf\x46\x7f\x2a\xa1\x1d\x29\xb6\x39\x9d\x6a\x42\xf1\xa7\xf6\xaa\xba\xe7\x51\xaa\xa4\xb5\xbd\xf0\x4b\x7e\x81\x44\xcf\x8a\x66\x04\xaf\x02\x81\x81\x00\xbd\xa5\xef\xf8\x36\x8a\x70\x98\x1e\x80\xde\xad\xbb\x67\x8c\xc7\x60\x62\xc5\x2f\x93\x39\x2c\xf6\x43\x4e\x18\x58\x60\x64\xed\x5b\x4d\xee\x77\xb2\x0c\xad\x3e\xff\x95\xb1\x05\x54\x28\xce\x9b\x0f\x83\xa0\x7d\x13\x7e\xfb\x67\x70\xda\x3c\x1e\xc3\xfb\x1f\x29\xba\x08\xff\x26\xb8\x73\xf4\x9c\x3e\x8e\x06\xc8\xcf\x44\x52\x96\x27\x73\x65\x20\x34\x20\x67\xdc\xca\x16\x36\x3b\x01\x0d\x62\x9a\x7f\x6c\x88\x29\x8a\x5f\x7a\x2e\xd6\xe8\x37\x2f\x3a\xe5\x8a\xa3\x9a\x83\x38\x4a\x62\x58\x3e\xcb\xfe\x0a\x25\x06\x2b\x7c\xa2\x0d\x6f";

//defined as a macro because cc_assert() doesn't exist in release build and the compiler creates unused function error
#define local_ccrsa_priv_n(fk)  ccn_nof(ccrsa_pubkeylength(ccrsa_ctx_public(fk)))

// Test RSA Encryption and Decryption
int fipspost_post_rsa_enc_dec(int fips_mode)
{
    /* Encrypt/Decrypt */
    size_t nbits=2048;
    cc_size n = ccn_nof(nbits);
    ccrsa_full_ctx_decl(ccn_sizeof(nbits), full_key);
    ccrsa_ctx_n(full_key)=n;

    int status = 0;

    // Import the key
    if (0 != ccrsa_import_priv(full_key, sizeof(rsa_test_key)-1, &rsa_test_key[0]))
    {
        failf("import");
        return CCERR_GENERIC_FAILURE;
    }

    ccrsa_pub_ctx_t pub_key = ccrsa_ctx_public(full_key);
    post_assert(n == local_ccrsa_priv_n(full_key));

    const unsigned char cleartext_data[] = "\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x30\x31\x32\x33\x34\x35\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x30\x31\x32\x33\x34\x35\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x30\x31\x32\x33\x34\x35\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x30\x31\x32\x33\x34\x35\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x30\x31\x32\x33\x34\x35\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x30\x31\x32\x33\x34\x35\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x30\x31\x32\x33\x34\x35\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x30\x31\x32\x33\x34\x35";
    cc_unit cleartext[n];
    status = ccn_read_uint(n, cleartext, sizeof(cleartext_data)-1, cleartext_data);
    post_assert(status == 0);
    const unsigned char *expected_ciphertext_data = POST_FIPS_RESULT_STR("\x53\xff\x13\x93\xc0\x9d\xc3\xf2\xd1\xa0\x02\x4b\x30\xcb\xa3\x16\x8e\xb5\x99\x59\x24\x3b\x93\x40\x2e\xbb\xf2\xd3\x16\x05\x19\x15\xfe\x0d\x08\x32\x06\x1b\xb7\x79\x8a\x90\x18\x18\x1d\x99\x28\x97\x63\x44\x9f\x4d\x27\x23\x71\x45\x42\xe3\x6f\x4e\xef\x97\xc5\x5f\x1f\x7e\x03\x4d\x5d\xb6\x65\x40\x2d\xcf\xde\x89\xa2\xa5\x61\xaf\x5a\xe0\x7a\x32\xe7\x7c\xc7\x65\xf1\xc2\xf7\xee\x58\x05\xf6\x81\x99\xe9\x1b\xe1\xa0\x6a\x23\x5c\xd8\x4c\x34\x0e\xb6\xdc\x9d\xff\xce\x6e\x93\x63\x57\x02\x7b\x83\xe2\x0a\xd0\xd6\x02\x0d\x56\x45\x15\xfc\xda\x1d\x41\xf9\xdb\xe3\x23\xd9\x8d\x35\xb2\x75\xae\xd9\x3c\x8c\xe8\xaf\x76\x9d\xe1\x89\x08\x38\xc9\x12\x64\x4d\xcb\xca\xbf\x95\x32\x39\x8f\xb5\x4d\xc1\xa1\xcf\x81\x1c\x56\x54\x31\xcf\x5d\x02\xc4\xbe\x79\x2f\x6f\x9a\x91\xa4\x5e\x02\xf6\xc9\x0a\x24\x53\x7f\xff\x2f\xae\xe3\x5c\x26\xee\x2c\x30\x8c\x2a\x54\xc2\x6c\x9b\xc4\x73\x27\x6b\x1d\x68\x76\x98\xc2\xfd\x76\x8b\x8f\x42\xe7\x08\xa5\xd1\xd0\xec\x3c\x89\xc2\x2b\x50\xdd\x7a\x76\xf2\x4b\x4c\xbe\x3f\x01\xd1\x39\x5b\x9d\x90\x38\x93\xcc\x82\x05\x01\x52\x5f");
    cc_unit expected_ciphertext[n];
    status = ccn_read_uint(n, expected_ciphertext, strlen((const char *)expected_ciphertext_data), expected_ciphertext_data);
    post_assert(status == 0);

    cc_unit encrypted_result[n], decrypted_result[n];

    /* Enc / Dec */
    // Encrypt cleartext into encrypted_result
    if (0 != ccrsa_pub_crypt(pub_key, encrypted_result, cleartext))
    {
        failf("ccrsa_pub_crypt");
        ccrsa_full_ctx_clear(ccn_sizeof(nbits), full_key);
        return CCERR_GENERIC_FAILURE;
    }

    // Verify encrypted_result != cleartext
    if (0 == ccn_cmp(n, encrypted_result, cleartext))
    {
        failf("RSA pub crypt");
        ccrsa_full_ctx_clear(ccn_sizeof(nbits), full_key);
        return CCERR_GENERIC_FAILURE;
    }

    // Verify encrypted_result == expected_ciphertext
    if (0 != ccn_cmp(n, encrypted_result, expected_ciphertext))
    {
        failf("encrypted_result != expected_ciphertext");
        ccrsa_full_ctx_clear(ccn_sizeof(nbits), full_key);
        return CCERR_GENERIC_FAILURE;
    }

    // Decrypt the expected_ciphertext into decrypted_result
    if (0 != ccrsa_priv_crypt(full_key, decrypted_result, expected_ciphertext))
    {
        failf("ccrsa_priv_crypt");
        ccrsa_full_ctx_clear(ccn_sizeof(nbits), full_key);
        return CCERR_GENERIC_FAILURE;
    }

    // Verify decrypted_result == cleartext
    if (0 != ccn_cmp(n, decrypted_result, cleartext))
    {
        failf("decrypted_result != cleartext");
        ccrsa_full_ctx_clear(ccn_sizeof(nbits), full_key);
        return CCERR_KAT_FAILURE;
    }

    return 0;
}
